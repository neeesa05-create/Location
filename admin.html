 <!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>Admin C&C Panel</title><script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script><style>@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');*,*:before,*:after{box-sizing:border-box}body{font-family:'Roboto',sans-serif;background-color:#121212;color:#e0e0e0;margin:0;user-select:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;height:100vh;overflow:hidden}.container{width:100%;height:100%;padding:20px;display:flex;flex-direction:column;overflow-y:auto}.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;flex-shrink:0}h1,h2{font-weight:700}h1{font-size:1.6rem;margin:0}h2{margin-top:25px;margin-bottom:15px;border-bottom:1px solid #333;padding-bottom:10px;font-size:1.2rem}#admin-section h2{margin-top:0}#logout-btn{padding:8px 16px;border:1px solid #e94560;border-radius:8px;background-color:transparent;color:#e94560;font-weight:600;cursor:pointer;transition:all .3s ease}#logout-btn:hover{background-color:#e94560;color:#fff}#message-area{text-align:center;padding:50px;font-size:1.2rem;color:#777;margin:auto 0}.table-wrapper{overflow-x:auto}.custom-table{width:100%;border-collapse:collapse;background-color:#1e1e1e;border-radius:12px;overflow:hidden}.custom-table th,.custom-table td{padding:15px;text-align:left;border-bottom:1px solid #333}.custom-table tr:last-child td{border-bottom:0}.custom-table th{background-color:#252525;color:#fff;font-weight:500;font-size:0.9rem;text-transform:uppercase;letter-spacing:1px}.custom-table td{color:#b3b3b3;font-size:1rem;word-break:break-all}.password-cell{font-style:italic;color:#f39c12}.ip-cell{font-family:monospace;color:#3498db}.status-active{color:#32de84}.status-protected{color:#3498db;font-weight:bold}.status-suspended{color:#e74c3c;font-weight:bold}.action-btn{padding:10px 15px;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:all .3s ease;width:100%}.action-btn.cleanup{background-color:#d35400;color:white}.action-btn.cleanup:hover{background-color:#e67e22}.action-btn.purge{background-color:#c0392b;color:white;font-weight:bold}.action-btn.purge:hover{background-color:#e74c3c}.action-btn.unban{background-color:#27ae60;color:white}.action-btn.unban:hover{background-color:#2ecc71}.action-btn.history{background-color:#3498db;color:white}.action-btn.history:hover{background-color:#5dade2}.action-btn.multi-account{background-color:#f39c12;color:white;margin-top:10px}.action-btn.multi-account:hover{background-color:#f1c40f}.action-btn.investigate{background-color:#8e44ad;color:white}.action-btn.investigate:hover{background-color:#9b59b6}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,.7);justify-content:center;align-items:center;backdrop-filter:blur(5px)}.modal.active{display:flex}.modal-content{background-color:#1e1e1e;margin:auto;padding:25px;border:1px solid #555;width:90%;max-width:1200px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.5);position:relative;animation:slide-in .4s ease-out;max-height:90vh;display:flex;flex-direction:column}.modal-content .modal-body{overflow-y:auto}.modal-close{color:#aaa;position:absolute;top:10px;right:20px;font-size:28px;font-weight:700;cursor:pointer}.modal-close:hover,.modal-close:focus{color:#fff;text-decoration:none}@keyframes slide-in{from{transform:translateY(-50px);opacity:0}to{transform:translateY(0);opacity:1}}#modal-message-area{padding:40px;text-align:center}.confirmation-actions{display:flex;justify-content:flex-end;gap:15px;margin-top:30px}#cancel-btn{background-color:#555;color:white}#cancel-btn:hover{background-color:#777}#toast-container{position:fixed;top:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:10px}.toast{padding:15px 20px;border-radius:8px;color:#fff;box-shadow:0 5px 15px rgba(0,0,0,.3);display:flex;align-items:center;gap:10px;opacity:0;transform:translateX(100%);animation:toast-in .5s forwards}.toast.success{background:linear-gradient(90deg,#27ae60,#2ecc71)}.toast.error{background:linear-gradient(90deg,#c0392b,#e74c3c)}.toast-icon{font-size:1.5rem;font-weight:bold}@keyframes toast-in{to{opacity:1;transform:translateX(0)}}@keyframes toast-out{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(100%)}}.investigation-summary{background-color:#252525;padding:20px;border-radius:8px;margin-bottom:25px;border:1px solid #444}.summary-item{margin-bottom:15px}.summary-item:last-child{margin-bottom:0}.summary-item strong{display:block;color:#aaa;font-size:.9rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}.summary-item span{font-size:1.1rem;word-break:break-all}@media(max-width:960px){.custom-table thead{display:none}.custom-table tr{display:block;margin-bottom:20px;border-radius:12px;border:1px solid #444;background-color:#282828;overflow:hidden;padding:15px}.custom-table td{display:grid;grid-template-columns:110px 1fr;text-align:left;padding:12px 0;border-bottom:1px solid #333;align-items:center;word-break:break-word}.custom-table td:last-child{border-bottom:0}.custom-table td:before{content:attr(data-label);font-weight:500;color:#888;padding-right:15px;white-space:nowrap}.action-cell{display:block;padding:20px 0 0 !important;border-top:1px solid #333;margin-top:15px}.action-cell .action-btn{width:100%}}</style></head><body><div class="container"><div class="header"><h1>Admin C&C Panel</h1><button id="logout-btn">Logout</button></div><div id="admin-section"><h2>Admin Information</h2><div class="table-wrapper"><table id="admin-user-table" class="custom-table"><thead><tr><th>Username</th><th>Email</th><th>Password</th><th>IP Address</th><th>Status</th><th>Action</th></tr></thead><tbody></tbody></table></div></div><div id="users-section"><h2>Public Users List</h2><p id="message-area">Loading user data...</p><div class="table-wrapper"><table id="public-users-table" class="custom-table" style="display:none"><thead><tr><th>Username</th><th>Email</th><th>Password</th><th>IP Address</th><th>Status</th><th>Action</th></tr></thead><tbody></tbody></table></div></div></div><div id="history-modal" class="modal"><div class="modal-content"><span class="modal-close">×</span><h2>Banned Devices History</h2><div class="modal-body"><p id="modal-message-area">Loading banned device data...</p><div class="table-wrapper"><table id="banned-table" class="custom-table" style="display:none"><thead><tr><th>Banned Username</th><th>Device Token</th><th>Banned At</th><th>Action</th></tr></thead><tbody></tbody></table></div></div></div></div><div id="multi-account-summary-modal" class="modal"><div class="modal-content"><span class="modal-close">×</span><h2>Suspicious Activity Report</h2><div id="multi-account-summary-results" class="modal-body"></div></div></div><div id="multi-account-details-modal" class="modal"><div class="modal-content"><span class="modal-close">×</span><h2 id="multi-account-details-title">Device Information</h2><div id="multi-account-details-results" class="modal-body"></div></div></div><div id="confirmation-modal" class="modal"><div class="modal-content" style="max-width:500px"><span class="modal-close">×</span><h2 id="confirmation-title" style="color:#e74c3c">Confirm Destructive Action</h2><p id="confirmation-message" style="font-size:1.1rem;line-height:1.6;"></p><div class="confirmation-actions"><button id="cancel-btn" class="action-btn">Cancel</button><button id="confirm-btn" class="action-btn purge">Confirm Purge</button></div></div></div><div id="toast-container"></div><script>let supabase;let allUsersCache=[];let suspiciousClusters=new Map();const PROTECTED_ADMIN_USER='Admin-doors';function showToast(message,type='success'){const container=document.getElementById('toast-container');const toast=document.createElement('div');toast.className=`toast ${type}`;const icon=type==='success'?'✓':'✗';toast.innerHTML=`<span class="toast-icon">${icon}</span><span>${message}</span>`;container.appendChild(toast);setTimeout(()=>{toast.style.animation='toast-out .5s forwards';setTimeout(()=>toast.remove(),500)},4000)}function setupModal(modalId){const modal=document.getElementById(modalId);const closeBtn=modal.querySelector('.modal-close');closeBtn.onclick=()=>modal.classList.remove('active');window.addEventListener('click',event=>{if(event.target==modal){modal.classList.remove('active')}})}function showConfirmationModal(message){return new Promise(resolve=>{const modal=document.getElementById('confirmation-modal');const messageP=document.getElementById('confirmation-message');const confirmBtn=document.getElementById('confirm-btn');const cancelBtn=document.getElementById('cancel-btn');const closeBtn=modal.querySelector('.modal-close');messageP.textContent=message;modal.classList.add('active');confirmBtn.onclick=()=>{modal.classList.remove('active');resolve(true)};cancelBtn.onclick=()=>{modal.classList.remove('active');resolve(false)};closeBtn.onclick=()=>{modal.classList.remove('active');resolve(false)}})}async function initApp(){if(localStorage.getItem('adminLoggedIn')!=='true'){window.location.href='admin-login.html';return}try{const response=await fetch('/api/config');const config=await response.json();if(!config.supabaseUrl||!config.supabaseAnonKey)throw new Error("Config not loaded");supabase=window.supabase.createClient(config.supabaseUrl,config.supabaseAnonKey);await fetchUsers();document.getElementById('logout-btn').addEventListener('click',()=>{localStorage.removeItem('adminLoggedIn');window.location.href='admin-login.html'});setupModal('history-modal');setupModal('multi-account-summary-modal');setupModal('multi-account-details-modal')}catch(err){console.error("Failed to init app:",err);showToast('Initialization Failed. Check server config.','error')}}async function cleanupAccount(username,button){button.disabled=true;button.textContent='Suspending...';try{await supabase.from('users').update({is_suspended:true}).eq('username',username);await supabase.from('locations').delete().eq('tracked_by_username',username);showToast(`Account '${username}' has been suspended successfully.`);await fetchUsers();if(document.getElementById('multi-account-details-modal').classList.contains('active')){const {clusterKey}=document.getElementById('multi-account-details-modal').dataset;showMultiAccountDetails(clusterKey)}}catch(error){console.error('Cleanup Error:',error);showToast(`Failed to suspend account: ${error.message}`,'error');button.disabled=false;button.textContent='Suspend Account'}}

// YEH FUNCTION AB DEVICE TOKEN BHI BAN KAREGA
async function purgeSingleUser(username, deviceToken) {
    try {
        await supabase.from('purged_users').insert([{ username: username }]);
        // Agar device token hai to usay banned_tokens table mein daal do
        if (deviceToken) {
            await supabase.from('banned_tokens').upsert({ token: deviceToken, banned_username: username }, { onConflict: 'token' });
        }
        await supabase.from('locations').delete().eq('tracked_by_username', username);
        await supabase.from('users').delete().eq('username', username);
    } catch (error) {
        if (error.code !== '23505') {
            console.error(`Failed to purge ${username}:`, error);
            showToast(`Error purging ${username}: ${error.message}`, 'error');
        }
    }
}

async function purgeUserAndLinks(username,button){button.disabled=true;button.textContent='Purging...';const targetUser=allUsersCache.find(u=>u.username===username);if(!targetUser){showToast('Target user not found.','error');return}const tokenToPurge=targetUser.device_token;const ipToPurge=targetUser.registration_ip;const accountsToPurge=allUsersCache.filter(u=>u.username!==PROTECTED_ADMIN_USER&&(u.device_token===tokenToPurge||(u.registration_ip&&u.registration_ip!=='N/A'&&u.registration_ip===ipToPurge)));const confirmed=await showConfirmationModal(`This will PERMANENTLY DELETE ${accountsToPurge.length} linked account(s), their location history, and BAN their device(s). This action cannot be undone.`);if(!confirmed){button.disabled=false;button.textContent='Purge User & Links';return}showToast(`Purging ${accountsToPurge.length} accounts...`,'error');
for(const user of accountsToPurge){
    // YAHAN HUM USERNAME KE SATH DEVICE TOKEN BHI BHAIJ RAHE HAIN
    await purgeSingleUser(user.username, user.device_token);
}
showToast('Purge complete. All linked accounts have been eliminated.','success');await fetchUsers()}

async function unbanDevice(token,button){button.disabled=true;button.textContent='Working...';try{const{error}=await supabase.from('banned_tokens').delete().eq('token',token);if(error)throw error;showToast('Device has been unbanned successfully.');await fetchBannedTokens(true)}catch(error){console.error('Unban Error:',error);showToast(`Failed to unban device: ${error.message}`,'error');button.disabled=false;button.textContent='Remove Ban'}}async function fetchUsers(){const messageArea=document.getElementById('message-area');const publicTable=document.getElementById('public-users-table');const publicTableBody=publicTable.querySelector('tbody');const adminTableBody=document.getElementById('admin-user-table').querySelector('tbody');try{const{data,error}=await supabase.from('users').select('*').order('created_at',{ascending:false});if(error){messageArea.textContent='Failed to load user data. Check Supabase RLS policies or console for errors.';throw error}messageArea.style.display='none';allUsersCache=data;publicTableBody.innerHTML='';adminTableBody.innerHTML='';const adminUser=data.find(user=>user.username===PROTECTED_ADMIN_USER);const regularUsers=data.filter(user=>user.username!==PROTECTED_ADMIN_USER);if(adminUser){const row=document.createElement('tr');row.innerHTML=`<td data-label="Username">${adminUser.username}</td><td data-label="Email">${adminUser.email}</td><td data-label="Password" class="password-cell">${adminUser.password}</td><td data-label="IP Address" class="ip-cell">${adminUser.registration_ip||'N/A'}</td><td data-label="Status" class="status-protected">Protected</td><td data-label="Action" class="action-cell"><button class="action-btn history">View Banned</button><button class="action-btn multi-account">Find Multi-Accounts</button></td>`;const historyBtn=row.querySelector('.history');historyBtn.addEventListener('click',()=>{document.getElementById('history-modal').classList.add('active');fetchBannedTokens(false)});const multiAccountBtn=row.querySelector('.multi-account');multiAccountBtn.addEventListener('click',()=>{document.getElementById('multi-account-summary-modal').classList.add('active');showMultiAccountSummary()});adminTableBody.appendChild(row)}if(regularUsers.length>0){publicTable.style.display='table';regularUsers.forEach(user=>{const row=document.createElement('tr');const statusText=user.is_suspended?'Suspended':'Active';const statusClass=user.is_suspended?'status-suspended':'status-active';row.innerHTML=`<td data-label="Username">${user.username}</td><td data-label="Email">${user.email}</td><td data-label="Password" class="password-cell">${user.password}</td><td data-label="IP Address" class="ip-cell">${user.registration_ip||'N/A'}</td><td data-label="Status" class="${statusClass}">${statusText}</td><td data-label="Action" class="action-cell"><button class="action-btn purge">Purge User & Links</button></td>`;const purgeBtn=row.querySelector('.purge');purgeBtn.addEventListener('click',()=>purgeUserAndLinks(user.username,purgeBtn));publicTableBody.appendChild(row)})}else if(regularUsers.length===0){publicTable.style.display='none';messageArea.style.display='block';messageArea.textContent='No public users have registered yet.'}}catch(err){showToast('Error fetching user data: '+err.message,'error');console.error('FetchUsers Error:',err);messageArea.textContent='Failed to load user data. Check console for errors.'}}async function fetchBannedTokens(isRefresh){const messageArea=document.getElementById('modal-message-area');const bannedTable=document.getElementById('banned-table');const tableBody=bannedTable.querySelector('tbody');if(!isRefresh){messageArea.style.display='block';messageArea.textContent='Loading...';bannedTable.style.display='none'}const{data,error}=await supabase.from('banned_tokens').select('*').order('created_at',{ascending:false});if(error){showToast('Error fetching banned device data.','error');return}tableBody.innerHTML='';if(data&&data.length>0){messageArea.style.display='none';bannedTable.style.display='table';data.forEach(ban=>{const row=document.createElement('tr');const bannedDate=new Date(ban.created_at).toLocaleString();row.innerHTML=`<td data-label="Banned Username">${ban.banned_username||'N/A'}</td><td data-label="Device Token">${ban.token}</td><td data-label="Banned At">${bannedDate}</td><td data-label="Action" class="action-cell"><button class="action-btn unban">Remove Ban</button></td>`;const unbanBtn=row.querySelector('.unban');unbanBtn.addEventListener('click',()=>unbanDevice(ban.token,unbanBtn));tableBody.appendChild(row)})}else{bannedTable.style.display='none';messageArea.style.display='block';messageArea.textContent='No devices have been banned yet.'}}function showMultiAccountSummary(){const resultsDiv=document.getElementById('multi-account-summary-results');resultsDiv.innerHTML='<p>Hunting for suspicious accounts...</p>';suspiciousClusters.clear();const tokenMap=new Map();const ipMap=new Map();allUsersCache.forEach(user=>{if(user.username===PROTECTED_ADMIN_USER||user.is_suspended)return;if(user.device_token){if(!tokenMap.has(user.device_token)){tokenMap.set(user.device_token,[])}tokenMap.get(user.device_token).push(user)}if(user.registration_ip&&user.registration_ip!=='N/A'){if(!ipMap.has(user.registration_ip)){ipMap.set(user.registration_ip,[])}ipMap.get(user.registration_ip).push(user)}});const duplicateTokens=Array.from(tokenMap.entries()).filter(([,users])=>users.length>1);const duplicateIps=Array.from(ipMap.entries()).filter(([,users])=>users.length>1);const consolidatedMap=new Map();const processGroup=(users,type,identifier)=>{const signature=users.map(u=>u.username).sort().join(',');if(!consolidatedMap.has(signature)){consolidatedMap.set(signature,{users:users,tokens:new Set(),ips:new Set()})}if(type==='token')consolidatedMap.get(signature).tokens.add(identifier);if(type==='ip')consolidatedMap.get(signature).ips.add(identifier)};duplicateTokens.forEach(([token,users])=>processGroup(users,'token',token));duplicateIps.forEach(([ip,users])=>processGroup(users,'ip',ip));if(consolidatedMap.size===0){resultsDiv.innerHTML='<p>No suspicious multi-account activity detected. System is clean.</p>';return}suspiciousClusters=consolidatedMap;let html=`<div class="table-wrapper"><table class="custom-table"><thead><tr><th>Shared Links</th><th>Account Count</th><th>Action</th></tr></thead><tbody>`;consolidatedMap.forEach((cluster,key)=>{const links=[];if(cluster.tokens.size>0)links.push(`${cluster.tokens.size} Device Token(s)`);if(cluster.ips.size>0)links.push(`${cluster.ips.size} IP(s)`);html+=`<tr><td data-label="Shared Links">${links.join(' & ')}</td><td data-label="Account Count">${cluster.users.length}</td><td data-label="Action" class="action-cell"><button class="action-btn investigate" data-cluster-key="${key}">Device</button></td></tr>`});html+='</tbody></table></div>';resultsDiv.innerHTML=html;resultsDiv.querySelectorAll('.investigate').forEach(button=>{button.addEventListener('click',e=>{const {clusterKey}=e.target.dataset;showMultiAccountDetails(clusterKey)})})}function showMultiAccountDetails(clusterKey){const cluster=suspiciousClusters.get(clusterKey);const detailsModal=document.getElementById('multi-account-details-modal');const resultsDiv=document.getElementById('multi-account-details-results');const title=document.getElementById('multi-account-details-title');detailsModal.dataset.clusterKey=clusterKey;const tokens=[...cluster.tokens].join(', ') || 'None';const ips=[...cluster.ips].join(', ') || 'None';title.innerHTML=`Device Information`;const usersToList=allUsersCache.filter(u=>cluster.users.some(cu=>cu.username===u.username));if(usersToList.length===0){resultsDiv.innerHTML='<p>No active accounts found for this group. They may have already been suspended.</p>';detailsModal.classList.add('active');return}let html=`<div class="investigation-summary"><div class="summary-item"><strong>Shared Device Token(s)</strong><span class="password-cell">${tokens}</span></div><div class="summary-item"><strong>Shared IP(s)</strong><span class="ip-cell">${ips}</span></div></div><div class="table-wrapper"><table class="custom-table"><thead><tr><th>Username</th><th>Email</th><th>Status</th><th>Action</th></tr></thead><tbody>`;usersToList.forEach(user=>{const statusText=user.is_suspended?'Suspended':'Active';const statusClass=user.is_suspended?'status-suspended':'status-active';const actionButton=user.is_suspended?`<span class="${statusClass}">Already Suspended</span>`:`<button class="action-btn cleanup" data-username="${user.username}">Suspend Account</button>`;html+=`<tr><td data-label="Username">${user.username}</td><td data-label="Email">${user.email}</td><td data-label="Status" class="${statusClass}">${statusText}</td><td data-label="Action" class="action-cell">${actionButton}</td></tr>`});html+='</tbody></table></div>';resultsDiv.innerHTML=html;resultsDiv.querySelectorAll('.cleanup').forEach(button=>{button.addEventListener('click',e=>{const {username}=e.target.dataset;cleanupAccount(username,e.target)})});detailsModal.classList.add('active')}initApp();</script></body></html> 
