<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>Admin C&C Panel</title><script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script><style>@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');:root{--primary-accent:#6a11cb;--secondary-accent:#2575fc;--text-light:#f0f0f0;--text-muted:#a0a0a0;--card-bg:rgba(255, 255, 255, 0.05);--card-border:rgba(255, 255, 255, 0.1);--body-bg:linear-gradient(160deg,#0f0c29 0%,#302b63 50%,#24243e 100%)}*{box-sizing:border-box}body{font-family:'Poppins',sans-serif;background:var(--body-bg);color:var(--text-light);margin:0;user-select:none;-webkit-user-select:none;height:100vh;overflow:hidden}.container{width:100%;height:100%;padding:25px;display:flex;flex-direction:column;overflow-y:auto}.header{margin-bottom:30px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:15px;animation:fadeInDown .5s ease-out}@keyframes fadeInDown{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}h1{font-weight:700;font-size:clamp(1.5rem,5vw,1.8rem)}#logout-btn{padding:8px 16px;border-radius:8px;font-weight:600;cursor:pointer;transition:all .3s ease;border:1px solid var(--card-border);background:var(--card-bg);color:var(--text-muted)}#logout-btn:hover{background:rgba(255,255,255,.1);color:var(--text-light)}.section-card{padding:25px;border-radius:15px;margin-bottom:30px;background:var(--card-bg);border:1px solid var(--card-border);backdrop-filter:blur(10px);animation:fadeInUp .5s .2s ease-out backwards}@keyframes fadeInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}h2{margin-top:0;margin-bottom:20px;font-size:1.4rem;font-weight:600}#message-area{text-align:center;padding:50px;font-size:1.2rem;color:var(--text-muted)}.table-wrapper{overflow-x:auto}.custom-table{width:100%;border-collapse:collapse}.custom-table th,.custom-table td{padding:15px;text-align:left;border-bottom:1px solid var(--card-border)}.custom-table tr:last-child td{border-bottom:0}.custom-table th{color:var(--text-light);font-weight:600;font-size:.9rem;text-transform:uppercase;letter-spacing:1px}.custom-table td{color:var(--text-muted);font-size:1rem;word-break:break-all}.password-cell{font-style:italic;color:#f39c12}.ip-cell{font-family:monospace;color:#3498db}.status-protected{color:#3498db;font-weight:700}.status-active{color:#2ecc71}.status-suspended{color:#e74c3c;font-weight:700}.action-btn{width:100%;padding:10px 15px;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:all .3s ease;color:white}.action-btn:hover{transform:scale(1.05);box-shadow:0 5px 15px rgba(0,0,0,.3)}.action-btn.view{background:linear-gradient(90deg,var(--primary-accent),var(--secondary-accent))}.action-btn.find{background:linear-gradient(90deg,#f39c12,#f1c40f);margin-top:10px}.action-btn.purge{background:linear-gradient(90deg,#c0392b,#e74c3c)}.action-btn.unban{background:linear-gradient(90deg,#27ae60,#2ecc71)}.action-btn.cleanup{background:linear-gradient(90deg,#d35400,#e67e22)}.modal-overlay{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.6);justify-content:center;align-items:center;backdrop-filter:blur(5px)}.modal-overlay.active{display:flex}.modal-content{background:var(--card-bg);border:1px solid var(--card-border);margin:auto;padding:25px;width:90%;max-width:1200px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.5);position:relative;animation:scaleIn .3s ease-out;display:flex;flex-direction:column;max-height:90vh}@keyframes scaleIn{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}.modal-content .modal-body{overflow-y:auto}.modal-close{color:var(--text-muted);position:absolute;top:15px;right:20px;font-size:28px;font-weight:700;cursor:pointer}.modal-close:hover,.modal-close:focus{color:var(--text-light)}.confirmation-actions{display:flex;justify-content:flex-end;gap:15px;margin-top:30px}.confirmation-actions #cancel-btn{background:#555}.confirmation-actions #cancel-btn:hover{background:#777}#toast-container{position:fixed;top:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:10px}.toast{padding:15px 20px;border-radius:8px;color:#fff;box-shadow:0 5px 15px rgba(0,0,0,.3);display:flex;align-items:center;gap:10px;opacity:0;transform:translateX(100%);animation:toast-in .5s forwards}.toast.success{background:linear-gradient(90deg,#27ae60,#2ecc71)}.toast.error{background:linear-gradient(90deg,#c0392b,#e74c3c)}.toast-icon{font-size:1.5rem;font-weight:bold}@keyframes toast-in{to{opacity:1;transform:translateX(0)}}@keyframes toast-out{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(100%)}}@media(max-width:960px){.custom-table thead{display:none}.custom-table tr{display:block;margin-bottom:20px;border-radius:12px;border:1px solid var(--card-border);background:rgba(0,0,0,.1);overflow:hidden;padding:15px}.custom-table td{display:grid;grid-template-columns:110px 1fr;text-align:left;padding:12px 0;border-bottom:1px solid var(--card-border);align-items:center}.custom-table td:last-child{border-bottom:0}.custom-table td:before{content:attr(data-label);font-weight:600;color:var(--text-light);padding-right:15px}.action-cell{display:block !important;padding-top:20px !important;border-top:1px solid var(--card-border);margin-top:15px}}</style></head><body><div class="container"><div class="header"><h1>Admin C&C Panel</h1><button id="logout-btn">Logout</button></div><div id="admin-section" class="section-card"><h2>Admin Information</h2><div class="table-wrapper"><table id="admin-user-table" class="custom-table"><thead><tr><th>Username</th><th>Email</th><th>Password</th><th>IP Address</th><th>Status</th><th>Action</th></tr></thead><tbody></tbody></table></div></div><div id="users-section" class="section-card"><h2>Public Users List</h2><p id="message-area">Loading user data...</p><div class="table-wrapper"><table id="public-users-table" class="custom-table" style="display:none"><thead><tr><th>Username</th><th>Email</th><th>Password</th><th>IP Address</th><th>Status</th><th>Action</th></tr></thead><tbody></tbody></table></div></div></div><div id="history-modal" class="modal-overlay"><div class="modal-content"><span class="modal-close">×</span><h2>Banned Devices History</h2><div class="modal-body"><p id="modal-message-area">Loading banned device data...</p><div class="table-wrapper"><table id="banned-table" class="custom-table" style="display:none"><thead><tr><th>Banned Username</th><th>Device Token</th><th>Banned At</th><th>Action</th></tr></thead><tbody></tbody></table></div></div></div></div><div id="multi-account-summary-modal" class="modal-overlay"><div class="modal-content"><span class="modal-close">×</span><h2>Suspicious Activity Report</h2><div id="multi-account-summary-results" class="modal-body"></div></div></div><div id="multi-account-details-modal" class="modal-overlay"><div class="modal-content"><span class="modal-close">×</span><h2 id="multi-account-details-title">Device Information</h2><div id="multi-account-details-results" class="modal-body"></div></div></div><div id="confirmation-modal" class="modal-overlay"><div class="modal-content" style="max-width:500px"><span class="modal-close">×</span><h2 id="confirmation-title" style="color:#e74c3c">Confirm Action</h2><p id="confirmation-message" style="font-size:1.1rem;line-height:1.6;"></p><div class="confirmation-actions"><button id="cancel-btn" class="action-btn">Cancel</button><button id="confirm-btn" class="action-btn purge">Confirm</button></div></div></div><div id="toast-container"></div><script>let supabase;let allUsersCache=[];let suspiciousClusters=new Map;const PROTECTED_ADMIN_USER="Admin-doors";function showToast(message,type="success"){const container=document.getElementById("toast-container");const toast=document.createElement("div");toast.className=`toast ${type}`;const icon=type==="success"?"✓":"✗";toast.innerHTML=`<span class="toast-icon">${icon}</span><span>${message}</span>`;container.appendChild(toast);setTimeout(()=>{toast.style.animation="toast-out .5s forwards";setTimeout(()=>toast.remove(),500)},4e3)}function setupModal(modalId){const modal=document.getElementById(modalId);const closeBtn=modal.querySelector(".modal-close");closeBtn.onclick=()=>modal.classList.remove("active");window.addEventListener("click",event=>{if(event.target==modal){modal.classList.remove("active")}}) }function showConfirmationModal(message){return new Promise(resolve=>{const modal=document.getElementById("confirmation-modal");const messageP=document.getElementById("confirmation-message");const confirmBtn=document.getElementById("confirm-btn");const cancelBtn=document.getElementById("cancel-btn");const closeBtn=modal.querySelector(".modal-close");messageP.textContent=message;modal.classList.add("active");confirmBtn.onclick=()=>{modal.classList.remove("active");resolve(true)};cancelBtn.onclick=()=>{modal.classList.remove("active");resolve(false)};closeBtn.onclick=()=>{modal.classList.remove("active");resolve(false)}})}async function initApp(){if(localStorage.getItem("adminLoggedIn")!=="true"){window.location.href="admin-login.html";return}try{const response=await fetch("/api/config");const config=await response.json();if(!config.supabaseUrl||!config.supabaseAnonKey)throw new Error("Config not loaded");supabase=window.supabase.createClient(config.supabaseUrl,config.supabaseAnonKey);await fetchUsers();document.getElementById("logout-btn").addEventListener("click",()=>{localStorage.removeItem("adminLoggedIn");window.location.href="admin-login.html"});setupModal("history-modal");setupModal("multi-account-summary-modal");setupModal("multi-account-details-modal")}catch(err){console.error("Failed to init app:",err);showToast("Initialization Failed. Check server config.","error")}}async function cleanupAccount(username,button){button.disabled=true;button.textContent="Suspending...";try{await supabase.from("users").update({is_suspended:true}).eq("username",username);await supabase.from("locations").delete().eq("tracked_by_username",username);showToast(`Account '${username}' has been suspended successfully.`);await fetchUsers();if(document.getElementById("multi-account-details-modal").classList.contains("active")){const{clusterKey}=document.getElementById("multi-account-details-modal").dataset;showMultiAccountDetails(clusterKey)}}catch(error){console.error("Cleanup Error:",error);showToast(`Failed to suspend account: ${error.message}`,"error");button.disabled=false;button.textContent="Suspend Account"}}async function purgeSingleUser(username,deviceToken){try{await supabase.from("purged_users").insert([{username:username}]);if(deviceToken){await supabase.from("banned_tokens").upsert({token:deviceToken,banned_username:username},{onConflict:"token"})}await supabase.from("locations").delete().eq("tracked_by_username",username);await supabase.from("users").delete().eq("username",username)}catch(error){if(error.code!=="23505"){console.error(`Failed to purge ${username}:`,error);showToast(`Error purging ${username}: ${error.message}`,"error")}}}async function purgeUserAndLinks(username,button){button.disabled=true;button.textContent="Purging...";const targetUser=allUsersCache.find(u=>u.username===username);if(!targetUser){showToast("Target user not found.","error");return}const tokenToPurge=targetUser.device_token;const ipToPurge=targetUser.registration_ip;const accountsToPurge=allUsersCache.filter(u=>u.username!==PROTECTED_ADMIN_USER&&(u.device_token===tokenToPurge||u.registration_ip&&u.registration_ip!=="N/A"&&u.registration_ip===ipToPurge));const confirmed=await showConfirmationModal(`This will PERMANENTLY DELETE ${accountsToPurge.length} linked account(s), their location history, and BAN their device(s). This action cannot be undone.`);if(!confirmed){button.disabled=false;button.textContent="Purge User & Links";return}showToast(`Purging ${accountsToPurge.length} accounts...`,"error");for(const user of accountsToPurge){await purgeSingleUser(user.username,user.device_token)}showToast("Purge complete. All linked accounts have been eliminated.","success");await fetchUsers()}async function unbanDevice(token,button){button.disabled=true;button.textContent="Working...";try{const{error}=await supabase.from("banned_tokens").delete().eq("token",token);if(error)throw error;showToast("Device has been unbanned successfully.");await fetchBannedTokens(true)}catch(error){console.error("Unban Error:",error);showToast(`Failed to unban device: ${error.message}`,"error");button.disabled=false;button.textContent="Remove Ban"}}async function fetchUsers(){const messageArea=document.getElementById("message-area");const publicTable=document.getElementById("public-users-table");const publicTableBody=publicTable.querySelector("tbody");const adminTableBody=document.getElementById("admin-user-table").querySelector("tbody");try{const{data,error}=await supabase.from("users").select("*").order("created_at",{ascending:false});if(error){messageArea.textContent="Failed to load user data.";throw error}messageArea.style.display="none";allUsersCache=data;publicTableBody.innerHTML="";adminTableBody.innerHTML="";const adminUser=data.find(user=>user.username===PROTECTED_ADMIN_USER);const regularUsers=data.filter(user=>user.username!==PROTECTED_ADMIN_USER);if(adminUser){const row=document.createElement("tr");row.innerHTML=`<td data-label="Username">${adminUser.username}</td><td data-label="Email">${adminUser.email}</td><td data-label="Password" class="password-cell">${adminUser.password}</td><td data-label="IP Address" class="ip-cell">${adminUser.registration_ip||"N/A"}</td><td data-label="Status" class="status-protected">Protected</td><td data-label="Action" class="action-cell"><button class="action-btn view">View Banned</button><button class="action-btn find">Find Multi-Accounts</button></td>`;const historyBtn=row.querySelector(".view");historyBtn.addEventListener("click",()=>{document.getElementById("history-modal").classList.add("active");fetchBannedTokens(false)});const multiAccountBtn=row.querySelector(".find");multiAccountBtn.addEventListener("click",()=>{document.getElementById("multi-account-summary-modal").classList.add("active");showMultiAccountSummary()});adminTableBody.appendChild(row)}if(regularUsers.length>0){publicTable.style.display="table";regularUsers.forEach(user=>{const row=document.createElement("tr");const statusText=user.is_suspended?"Suspended":"Active";const statusClass=user.is_suspended?"status-suspended":"status-active";row.innerHTML=`<td data-label="Username">${user.username}</td><td data-label="Email">${user.email}</td><td data-label="Password" class="password-cell">${user.password}</td><td data-label="IP Address" class="ip-cell">${user.registration_ip||"N/A"}</td><td data-label="Status" class="${statusClass}">${statusText}</td><td data-label="Action" class="action-cell"><button class="action-btn purge">Purge User & Links</button></td>`;const purgeBtn=row.querySelector(".purge");purgeBtn.addEventListener("click",()=>purgeUserAndLinks(user.username,purgeBtn));publicTableBody.appendChild(row)})}else if(regularUsers.length===0){publicTable.style.display="none";messageArea.style.display="block";messageArea.textContent="No public users have registered yet."}}catch(err){showToast("Error fetching user data: "+err.message,"error");console.error("FetchUsers Error:",err);messageArea.textContent="Failed to load user data. Check console."}}async function fetchBannedTokens(isRefresh){const messageArea=document.getElementById("modal-message-area");const bannedTable=document.getElementById("banned-table");const tableBody=bannedTable.querySelector("tbody");if(!isRefresh){messageArea.style.display="block";messageArea.textContent="Loading...";bannedTable.style.display="none"}const{data,error}=await supabase.from("banned_tokens").select("*").order("created_at",{ascending:false});if(error){showToast("Error fetching banned device data.","error");return}tableBody.innerHTML="";if(data&&data.length>0){messageArea.style.display="none";bannedTable.style.display="table";data.forEach(ban=>{const row=document.createElement("tr");const bannedDate=(new Date(ban.created_at)).toLocaleString();row.innerHTML=`<td data-label="Banned Username">${ban.banned_username||"N/A"}</td><td data-label="Device Token">${ban.token}</td><td data-label="Banned At">${bannedDate}</td><td data-label="Action" class="action-cell"><button class="action-btn unban">Remove Ban</button></td>`;const unbanBtn=row.querySelector(".unban");unbanBtn.addEventListener("click",()=>unbanDevice(ban.token,unbanBtn));tableBody.appendChild(row)})}else{bannedTable.style.display="none";messageArea.style.display="block";messageArea.textContent="No devices have been banned yet."}}function showMultiAccountSummary(){const resultsDiv=document.getElementById("multi-account-summary-results");resultsDiv.innerHTML="<p>Hunting for suspicious accounts...</p>";suspiciousClusters.clear();const tokenMap=new Map;const ipMap=new Map;allUsersCache.forEach(user=>{if(user.username===PROTECTED_ADMIN_USER||user.is_suspended)return;if(user.device_token){if(!tokenMap.has(user.device_token)){tokenMap.set(user.device_token,[])}tokenMap.get(user.device_token).push(user)}if(user.registration_ip&&user.registration_ip!=="N/A"){if(!ipMap.has(user.registration_ip)){ipMap.set(user.registration_ip,[])}ipMap.get(user.registration_ip).push(user)}});const duplicateTokens=Array.from(tokenMap.entries()).filter(([,users])=>users.length>1);const duplicateIps=Array.from(ipMap.entries()).filter(([,users])=>users.length>1);const consolidatedMap=new Map;const processGroup=(users,type,identifier)=>{const signature=users.map(u=>u.username).sort().join(",");if(!consolidatedMap.has(signature)){consolidatedMap.set(signature,{users:users,tokens:new Set,ips:new Set})}if(type==="token")consolidatedMap.get(signature).tokens.add(identifier);if(type==="ip")consolidatedMap.get(signature).ips.add(identifier)};duplicateTokens.forEach(([token,users])=>processGroup(users,"token",token));duplicateIps.forEach(([ip,users])=>processGroup(users,"ip",ip));if(consolidatedMap.size===0){resultsDiv.innerHTML='<p style="padding: 20px;">No suspicious multi-account activity detected. System is clean.</p>';return}suspiciousClusters=consolidatedMap;let html=`<div class="table-wrapper"><table class="custom-table"><thead><tr><th>Shared Links</th><th>Account Count</th><th>Action</th></tr></thead><tbody>`;consolidatedMap.forEach((cluster,key)=>{const links=[];if(cluster.tokens.size>0)links.push(`${cluster.tokens.size} Device Token(s)`);if(cluster.ips.size>0)links.push(`${cluster.ips.size} IP(s)`);html+=`<tr><td data-label="Shared Links">${links.join(" & ")}</td><td data-label="Account Count">${cluster.users.length}</td><td data-label="Action" class="action-cell"><button class="action-btn view" data-cluster-key="${key}">Investigate</button></td></tr>`});html+="</tbody></table></div>";resultsDiv.innerHTML=html;resultsDiv.querySelectorAll(".view").forEach(button=>{button.addEventListener("click",e=>{const{clusterKey}=e.target.dataset;showMultiAccountDetails(clusterKey)})})}function showMultiAccountDetails(clusterKey){const cluster=suspiciousClusters.get(clusterKey);const detailsModal=document.getElementById("multi-account-details-modal");const resultsDiv=document.getElementById("multi-account-details-results");const title=document.getElementById("multi-account-details-title");detailsModal.dataset.clusterKey=clusterKey;const tokens=[...cluster.tokens].join(", ") || "None";const ips=[...cluster.ips].join(", ") || "None";title.innerHTML=`Device Information`;const usersToList=allUsersCache.filter(u=>cluster.users.some(cu=>cu.username===u.username));if(usersToList.length===0){resultsDiv.innerHTML='<p style="padding: 20px;">No active accounts found for this group. They may have been purged.</p>';detailsModal.classList.add
